<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Catalog of Life - Search Interface</title>
<link href='http://fonts.googleapis.com/css?family=Josefin+Sans'
    rel='stylesheet' type='text/css'>
<style>
#mol {
    font-family: 'Josefin Sans', arial, serif;
    font-size: 26px;
    font-style: normal;
    font-weight: 400;
    text-shadow: none;
    text-decoration: none;
    text-transform: none;
    letter-spacing: -0.037em;
    word-spacing: -0.108em;
    line-height: 1.17;
}

#submitButton {
    position: fixed;
    top: 53px;
}
#checkbox {
    position: fixed;
    top: 53px;
    left: 380px;
}
#cbtext {
    position: fixed;
    top: 56px;
    left: 400px;
}

</style>
<script src="http://www.google.com/jsapi"></script>
<script src="../static/tablequerywrapper.js"></script>
</head>
<body style="font: 75% Lucida Grande, Trebuchet MS">
<div id='mol'>Map of Life</div><br>
<input type='search' id='queryText' style="width: 300px;">
<button id='submitButton' value="submit" type="submit">Search</button>
<input type='checkbox' id='checkbox'></input><div id='cbtext'>Species with range maps</div>
<p>
<div id="table"></div>
<script>
google.load('visualization', '1', {
    'packages' : [ 'table' ]
});

google.setOnLoadCallback(init);

var dataSourceUrl = '/api/taxonomy';
var query, options, container, submitButton;

var app = app || {};

app.urlParams = {};

app.parseUrlParams = function() {
    var e,
    a = /\+/g,  // Regex for replacing addition symbol with a space
    r = /([^&=]+)=?([^&]*)/g,
    d = function (s) { return decodeURIComponent(s.replace(a, " ")); },
    q = window.location.search.substring(1) || window.location.hash.replace('#', '').replace('?', '');
    app.urlParams = {};
    while (e = r.exec(q)) {
        app.urlParams[d(e[1])] = d(e[2]);
    }
}

$ = (function() {
    var queryPlaceholder = "concolor";
    var $ = function(id) {
        return document.getElementById(id);
    }
    $('queryText').setAttribute('placeholder', queryPlaceholder);
    $('queryText').addEventListener('keyup', function(evt) {
        if (evt.keyCode === 13) {
            $('submitButton').click();
        }
    }, false);
    app.parseUrlParams();
    return $;
}());

function init() {
    query = new google.visualization.Query(dataSourceUrl);
    container = document.getElementById("table");
    options = {
        'pageSize' : -1,
        'sort' : 'disable'
    };
    submitButton = $('submitButton');
}

function sendAndDraw() {
    query.abort();
    var callback = function(isDone) {
        if (isDone) {
            $('submitButton').removeAttribute('disabled', 0);
            } else {
            $('submitButton').setAttribute('disabled', 1);
        }
    }
    var tableQueryWrapper = new TableQueryWrapper(query, container, options, callback);
    tableQueryWrapper.sendAndDraw();
}

function setOption(prop, value, send) {
    options[prop] = value;
    if (send == null || send == true) {
        sendAndDraw();
    }
}

function setOptions(opts) {
    for (name in opts) {
        var value = opts[name];
        options[name] = value; 
    }
    sendAndDraw();
}

app.handleOnClick = function(evt) {
    var m = $('checkbox').checked,
        q = $('queryText').value || $('queryText').getAttribute('placeholder'),
        opts = {};
    opts['maps'] = m;
    if (q) {
        opts['gql'] = q;
    }
    setOptions(opts);    
    app.go(q, m);
}

app.go = function(q, m) {
    var search = '?';
    if (q) {
        search = search + 'q=' + q;
    }
    if (m) {
        search = search + '&maps=' + m;
    }  
    if (typeof(window.history.pushState) == 'function') {        
        window.history.pushState(q, document.title, search);
    } else {
        window.location.hash = '#' + search;
    }
}

window.onhashchange = function(event) {
    window.onpopstate(event);	
}

window.onpopstate = function(event) {
    app.parseUrlParams();
    var q = app.urlParams['q'],
        maps = app.urlParams['maps'];
    if (event.state == null && q == null && maps == null) {
        app.setupPage(null, null);
    } else {
        app.setupPage(q, maps);
    }
}

app.setupPage = function(q, maps) {
    var opts = {};
    if (q == null && maps == null) {
        $('queryText').value = '';
        $('checkbox').checked = false;
        $('table').innerHTML = '';
        return;
    }
    if (maps == null) {       
        $('checkbox').checked = false;
    } else if (maps == 'false') {
        $('checkbox').checked = false;
    } else if (maps == 'true') {
        $('checkbox').checked = true;
    } else {
        $('checkbox').checked = false;
    } 
    $('queryText').value = q;
    opts['maps'] = $('checkbox').checked;
    opts['gql'] = q;
    setOptions(opts);
  }

app.checkboxHandler = function(evt) {
    app.handleOnClick();
}

$('checkbox').addEventListener('click', app.checkboxHandler, false);
$('submitButton').addEventListener('click', app.handleOnClick, false);
</script>
</body>
</html>